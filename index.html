<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Letras & Música – Comparsa Moreno Polo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --brand1:#6366f1; --brand2:#7c3aed; }
    html,body { height: 100%; }
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
           background: radial-gradient(circle at 20% 20%, #a5b4fc 0%, #f5f7fa 100%);
           min-height: 100vh; }
    body::before { content:""; position: fixed; inset: 0; z-index: -1; opacity: .18; pointer-events:none;
      background: linear-gradient(135deg, var(--brand1) 0%, var(--brand2) 100%); }

    .header { background: linear-gradient(90deg, var(--brand1) 0%, var(--brand2) 100%); color:#fff; }

    .navbar { position: sticky; top: .75rem; z-index: 40; border-radius: 16px;
      background: linear-gradient(90deg, var(--brand1) 0%, var(--brand2) 100%);
      box-shadow: 0 4px 24px rgba(79,70,229,.18); border:2px solid #fff; backdrop-filter: blur(8px); }

    .tab-btn { background: transparent; color:#fff; font-weight:700; border:none; border-radius:12px; margin:0 .5rem;
      padding:.75rem 1.25rem; font-size:1.05rem; transition: background .25s, transform .15s, color .25s; }
    .tab-btn[aria-selected="true"] { background: rgba(255,255,255,.18); transform: scale(1.05); border:2px solid #fff; }
    .tab-btn:hover { background: rgba(255,255,255,.28); }

    .glass { background: rgba(255,255,255,.7); border:1px solid #e0e7ff; border-radius: 18px; box-shadow: 0 8px 32px rgba(79,70,229,.12); backdrop-filter: blur(6px); }

    .btn-primary { background: linear-gradient(90deg, var(--brand1) 0%, var(--brand2) 100%); color:#fff; }
    .btn-primary:hover { filter: brightness(.95); transform: translateY(-1px); }
    .btn-danger  { background: linear-gradient(90deg,#ef4444 0%,#f87171 100%); color:#fff; }
    .btn-danger:hover { filter: brightness(.95); }
    .btn-secondary { background: linear-gradient(90deg,#6b7280 0%, #a1a1aa 100%); color:#fff; }

    .song-item { border-left:4px solid var(--brand1); transition: transform .15s, box-shadow .15s; }
    .song-item:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(79,70,229,.18); }

    .modal-backdrop { background: rgba(0,0,0,.5); }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="header py-6 px-4 shadow-md">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold text-center tracking-tight">Letras y Música – Comparsa</h1>
    </div>
  </header>

  <!-- Navbar -->
  <nav class="container mx-auto px-4 mt-4 mb-6">
    <div class="navbar flex items-center justify-center py-2">
      <button id="tab-list" class="tab-btn" aria-controls="section-list" aria-selected="true">
        <i class="fa-solid fa-music mr-2"></i> Biblioteca
      </button>
      <button id="tab-add" class="tab-btn" aria-controls="section-add" aria-selected="false">
        <i class="fa-solid fa-plus-circle mr-2"></i> Agregar
      </button>
    </div>
  </nav>

  <!-- Main -->
  <main class="container mx-auto px-4 pb-16">
    <!-- ADD -->
    <section id="section-add" class="hidden">
      <div class="max-w-2xl mx-auto glass p-6">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Agregar nueva canción</h2>
        <form id="form-add" class="space-y-4" autocomplete="off">
          <div>
            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
            <input id="title" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ej. Paso Doble 1" />
          </div>
          <div>
            <label for="lyrics" class="block text-sm font-medium text-gray-700 mb-1">Letra (opcional)</label>
            <textarea id="lyrics" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Pega aquí la letra..."></textarea>
          </div>
          <div>
            <label for="media" class="block text-sm font-medium text-gray-700 mb-1">Archivo de audio o vídeo (opcional)</label>
            <input id="media" type="file" accept="audio/*,video/mp4,video/webm" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <p class="text-xs text-gray-500 mt-1">Se guardará localmente (localStorage) como Data URL. Archivos muy grandes pueden no caber.</p>
          </div>
          <div class="pt-2">
            <button id="btn-save" type="submit" class="btn-primary px-6 py-2 rounded-md font-medium w-full flex items-center justify-center">
              <i class="fa-solid fa-save mr-2"></i> Guardar
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- LIST -->
    <section id="section-list" class="block">
      <div class="max-w-2xl mx-auto glass p-6">
        <h2 class="text-xl font-bold mb-4 text-gray-800">Biblioteca</h2>
        <div class="mb-4">
          <input id="search" type="text" placeholder="Buscar por título..." class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div id="songs" class="space-y-4 mt-6">
          <div class="text-center text-gray-500">
            <p>No hay canciones en tu biblioteca.</p>
            <p>Agrega tu primera canción con el formulario.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- LYRICS MODAL -->
  <div id="modal-lyrics" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative bg-white w-11/12 md:w-3/4 lg:w-1/2 max-h-screen overflow-auto p-6 rounded-lg shadow-xl">
      <h3 id="modal-lyrics-title" class="text-xl font-bold mb-4"></h3>
      <pre id="modal-lyrics-body" class="whitespace-pre-wrap text-gray-700 bg-gray-50 border rounded p-4 max-h-[60vh] overflow-auto"></pre>
      <div class="mt-6 text-right">
        <button id="btn-lyrics-close" class="btn-secondary px-4 py-2 rounded-md">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- DELETE MODAL -->
  <div id="modal-delete" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative bg-white w-11/12 md:w-1/2 lg:w-1/3 p-6 rounded-lg shadow-xl">
      <h3 class="text-xl font-bold mb-4">Confirmar eliminación</h3>
      <p>¿Seguro que deseas eliminar esta canción? Esta acción no se puede deshacer.</p>
      <div class="mt-6 flex justify-end gap-3">
        <button id="btn-del-cancel" class="btn-secondary px-4 py-2 rounded-md">Cancelar</button>
        <button id="btn-del-confirm" class="btn-danger px-4 py-2 rounded-md">Eliminar</button>
      </div>
    </div>
  </div>

  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
      import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
      // Si quieres usar analytics, puedes importar y usarlo:
      // import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDzZTGkzawL0H7_C_86sk20yp5occ52JZg",
        authDomain: "webletras-7157b.firebaseapp.com",
        projectId: "webletras-7157b",
        storageBucket: "webletras-7157b.firebasestorage.app",
        messagingSenderId: "989001001547",
        appId: "1:989001001547:web:a4bb147b66df7a4e1f3bce",
        measurementId: "G-5SLFFXNFRM"
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      // const analytics = getAnalytics(app); // Si lo necesitas

      // ===== Referencias DOM =====
      const tabAdd  = document.getElementById('tab-add');
      const tabList = document.getElementById('tab-list');
      const secAdd  = document.getElementById('section-add');
      const secList = document.getElementById('section-list');
      const formAdd = document.getElementById('form-add');
      const inTitle = document.getElementById('title');
      const inLyrics= document.getElementById('lyrics');
      const inMedia = document.getElementById('media');
      const btnSave = document.getElementById('btn-save');
      const search  = document.getElementById('search');
      const songsEl = document.getElementById('songs');
      const modalLyrics      = document.getElementById('modal-lyrics');
      const modalLyricsTitle = document.getElementById('modal-lyrics-title');
      const modalLyricsBody  = document.getElementById('modal-lyrics-body');
      const btnLyricsClose   = document.getElementById('btn-lyrics-close');
      const modalDelete      = document.getElementById('modal-delete');
      const btnDelCancel     = document.getElementById('btn-del-cancel');
      const btnDelConfirm    = document.getElementById('btn-del-confirm');
      let songIdToDelete = null;

      // ===== Navegación =====
      function setActive(tab){
        const isAdd = tab === 'add';
        secAdd.classList.toggle('hidden', !isAdd);
        secAdd.classList.toggle('block', isAdd);
        secList.classList.toggle('hidden', isAdd);
        secList.classList.toggle('block', !isAdd);
        tabAdd.setAttribute('aria-selected', isAdd ? 'true' : 'false');
        tabList.setAttribute('aria-selected', !isAdd ? 'true' : 'false');
        if(!isAdd){ loadSongs(search?.value?.trim() || ''); window.scrollTo({ top:0, behavior:'smooth' }); }
      }
      tabAdd.addEventListener('click', () => setActive('add'));
      tabList.addEventListener('click', () => setActive('list'));
      setActive('list'); // estado inicial: Biblioteca

      // ===== Firestore =====
      async function readAll(q=''){
        let qRef = collection(db, 'songs');
        let qSongs;
        if(q){
          qSongs = query(qRef, where('title', '>=', q), where('title', '<=', q + '\uf8ff'), orderBy('title'), orderBy('createdAt', 'desc'));
        } else {
          qSongs = query(qRef, orderBy('createdAt', 'desc'));
        }
        const snap = await getDocs(qSongs);
        return snap.docs.map(docu => ({ id: docu.id, ...docu.data() }));
      }
      async function writeSong(song){
        await addDoc(collection(db, 'songs'), song);
      }
      async function deleteSong(id){
        await deleteDoc(doc(db, 'songs', id));
      }

      // ===== Render =====
      async function loadSongs(q=''){
        let items = await readAll(q);
        songsEl.innerHTML = '';
        if(items.length === 0){
          const empty = document.createElement('div');
          empty.className = 'text-center text-gray-500';
          empty.innerHTML = q ? '<p>No se encontraron canciones que coincidan con tu búsqueda.</p>' : '<p>No hay canciones en tu biblioteca.</p><p>Agrega tu primera canción con el formulario.</p>';
          songsEl.appendChild(empty);
          return;
        }
        items.forEach(s => songsEl.appendChild(renderSong(s)));
      }

      function renderSong(song){
        const wrap = document.createElement('div');
        wrap.className = 'song-item bg-white p-4 rounded-lg shadow-sm';
        wrap.dataset.id = song.id;
        const title = document.createElement('h3');
        title.className = 'font-medium text-lg text-gray-800 mb-2';
        title.textContent = song.title;
        let player = null;
        if(song.mediaUrl){
          if(song.mediaType && song.mediaType.startsWith('video/')){
            player = document.createElement('video');
            player.controls = true;
            player.className = 'w-full mt-2 rounded';
            player.src = song.mediaUrl;
          } else {
            player = document.createElement('audio');
            player.controls = true;
            player.className = 'w-full mt-2';
            player.src = song.mediaUrl;
          }
        }
        const btns = document.createElement('div');
        btns.className = 'flex flex-wrap gap-2 mt-3';
        if(player){
          const bPlay = document.createElement('button');
          bPlay.className = 'btn-secondary px-3 py-1 rounded-md text-sm flex items-center';
          bPlay.innerHTML = '<i class="fa-solid fa-play mr-1"></i> Reproducir';
          bPlay.addEventListener('click', () => {
            if(player.paused){ player.play(); bPlay.innerHTML = '<i class="fa-solid fa-pause mr-1"></i> Pausar'; }
            else { player.pause(); bPlay.innerHTML = '<i class="fa-solid fa-play mr-1"></i> Reproducir'; }
          });
          btns.appendChild(bPlay);
        }
        if(song.lyrics){
          const bLyrics = document.createElement('button');
          bLyrics.className = 'btn-secondary px-3 py-1 rounded-md text-sm flex items-center';
          bLyrics.innerHTML = '<i class="fa-solid fa-align-left mr-1"></i> Ver letra';
          bLyrics.addEventListener('click', () => openLyrics(song.title, song.lyrics));
          btns.appendChild(bLyrics);
        }
        const bDelete = document.createElement('button');
        bDelete.className = 'btn-danger px-3 py-1 rounded-md text-sm flex items-center ml-auto';
        bDelete.innerHTML = '<i class="fa-solid fa-trash mr-1"></i> Eliminar';
        bDelete.addEventListener('click', () => confirmDelete(song.id));
        btns.appendChild(bDelete);
        wrap.appendChild(title);
        if(player) wrap.appendChild(player);
        wrap.appendChild(btns);
        return wrap;
      }

      // ===== Form Add =====
      formAdd.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const title = inTitle.value.trim();
        const lyrics = inLyrics.value.trim();
        const file = inMedia.files[0];
        if(!title){ alert('Por favor, ingresa un título.'); return; }
        const setBusy = (busy) => {
          btnSave.disabled = busy;
          btnSave.innerHTML = busy ? '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Guardando...' : '<i class="fa-solid fa-save mr-2"></i> Guardar';
        };
        setBusy(true);
        const toDataUrl = (file) => new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); });
        let mediaUrl = '';
        let mediaType = '';
        if(file){
          try {
            mediaUrl = await toDataUrl(file);
            mediaType = file.type || '';
          } catch(e){
            console.error(e);
            alert('No se pudo leer el archivo.');
          }
        }
        await writeSong({ title, lyrics, mediaUrl, mediaType, createdAt: new Date().toISOString() });
        formAdd.reset();
        setBusy(false);
        setActive('list');
        loadSongs();
      });

      // ===== Búsqueda =====
      search?.addEventListener('input', () => loadSongs(search.value.trim()));

      // ===== Modales =====
      function openLyrics(title, text){
        modalLyricsTitle.textContent = title;
        modalLyricsBody.textContent = text || '';
        modalLyrics.classList.remove('hidden');
        modalLyrics.classList.add('flex');
      }
      function closeLyrics(){
        modalLyrics.classList.add('hidden');
        modalLyrics.classList.remove('flex');
      }
      btnLyricsClose.addEventListener('click', closeLyrics);

      function confirmDelete(id){
        songIdToDelete = id;
        modalDelete.classList.remove('hidden');
        modalDelete.classList.add('flex');
      }
      function closeDelete(){
        modalDelete.classList.add('hidden');
        modalDelete.classList.remove('flex');
        songIdToDelete = null;
      }
      btnDelCancel.addEventListener('click', closeDelete);
      btnDelConfirm.addEventListener('click', async () => {
        if(!songIdToDelete) return;
        await deleteSong(songIdToDelete);
        closeDelete();
        loadSongs(search?.value?.trim() || '');
      });

      // Cerrar modales clicando fuera
      window.addEventListener('click', (e) => {
        if(e.target === modalLyrics) closeLyrics();
        if(e.target === modalDelete) closeDelete();
      });

      // Cargar al inicio
      loadSongs();
    </script>
</body>
</html>
